# Master thesis - Counterfactuals - Arne Rustad


This is a Github repository for the code associated with Arne Rustad's master thesis. Below we describe briefly what each code file's purpose is and give the abstract for the written master thesis titled *"tabGAN: A Framework for UtilizingTabular GAN for Data Synthesizing and Generation of Counterfactual Explanations"*


## Code file explanations

1. **Imports.ipynb**: This jupyter notebook file contains all the imports required by the different scripts in this repository. They are created as a separate file that can be loaded to avoid repeating the process for each script and to make it an easy process to update package requirements.
2. **explore_and_clean_adult_dataset.R**: This R file contains the code performing very simple exploratory analysis of the Adult dataset in addition to preprocessing of the Adult dataset. Lastly, it also prints the latex code required for the summary tables of the Adult datasets used in the project report.
3. **tabGAN.ipynb**: This jupyter notebook file contains the Python class for the methods tabGAN, tabGAN-qt, tabGAN-qtr and tabGAN-cf referenced in the paper.
4. **utils.ipynb**: Jupyter notebook file containing all the help functions used by later Python scripts.
5. **plot_parteto_frontier_example.R**: R code file for generating the Pareto frontier figure in the project thesis paper.
6. **tabGAN_plot_model_for_adult_dataset.ipynb**: Jupyter notebook file for creating svg drawings of the generator and critic architecture for the tabGAN method fitted to the Adult dataset. Both svg images were included in the paper.
7. **tabGAN_evaluate_on_toy_datasets.ipynb**: Jupyter notebook file where the performance of the tabGAN data synthesizer is evaluated on two simulated (toy) datasets.
8. **TabFairGAN_nofair.ipynb**: The modified code for the tabFairGAN method (and thus the tabFairGAN-mod method described in this paper). The original code script was fetched from (https://github.com/amirarsalan90/TabFairGAN).
9. **TGAN_generate_synthetic_datasets.ipynb**: Jupyter notebook file for generating the synthetic datasets used in the analyses in the jupyter notebook files *tabGAN_compare_on_adult_dataset.ipynb* and *tabGAN_compare_prediction_on_synthetic_adult_dataset.ipynb*. The reason the synthetic datasets created using TGAN need to be created in a different file is that TGAN requires Tensorflow version 1, while tabGAN, tabGAN-qt and tabGAN-qtr is implemented for Tensorflow version 2. Thus we had to create separate Anaconda environments. The link to the Github repository for TGAN is (https://github.com/sdv-dev/TGAN)
10. **tabFairGAN_generating_synthetic_datasets**: Jupyter notebook file for generating the synthetic datasets used in the analyses in the jupyter notebook files *tabGAN_compare_on_adult_dataset.ipynb* and *tabGAN_compare_prediction_on_synthetic_adult_dataset.ipynb*.
11. **tabGAN_compare_on_adult_dataset.ipynb**: Jupyter notebook file for performing comparison of the methods tabGAN, tabGAN-qt, tabGAN-qtr, TGAN, CTGAN, tabFairGAN and tabFairGAN-mod with respect to recreation of marginal and pairwise joint column distributions. The link to the CTGAN Github repository is (https://github.com/sdv-dev/CTGAN)
12. **tabGAN_compare_prediction_on_synthetic_adult_dataset.ipynb**: Jupyter notebook file for performing comparison of the methods tabGAN, tabGAN-qt, tabGAN-qtr, TGAN, CTGAN, tabFairGAN and tabFairGAN-mod with respect to machine learning efficacy (test AUC and accuracy on the original Adult test dataset for XGBoost models trained on synthetic train datasets generated by the different data synthesizer methods).
13. **hyperparameter_tuning_exgboost_adult.ipynb**: Jupyter notebook file for performing hyperparameter tuning of XGBoost on the Adult dataset. NOT USED IN THE THESIS.
14. **create_counterfactuals_with_moc.ipynb**: Jupyter notebook file for creating counterfactual explanations for the analysis performed in *compare_counterfactuals_on_adult_dataset.ipynb*.
15. **compare_counterfactuals_on_adult_dataset.ipynb** Jupyter notebook file for comparing counterfactuals generated by the model-based counterfactual method tabGAN-cf developed in this thesis and the algorithmic-based counterfactual method MOC. The counterfactual methods were compared informally on a simulated dataset and the Adult dataset.


## Master thesis abstract

> Counterfactual explanations is an emerging method for explaining predictions from black-box models by utilizing "what-if" scenarios. In this thesis, we create a Wasserstein Generative Adversarial Network (WGAN) based tabular data synthesizing framework, tabGAN, and later we modify this WGAN framework to create a model-based counterfactual synthesizer framework, which we call tabGANcf. The counterfactual framework is more a proof-of-concept, while the data synthesizing framework is more complete, with a lot of customization available and default values based on extensive hyperparameter tuning. During the creation of the data synthesizing framework tabGAN, we also create a new type of transformation, which we include as a preprocessing option for the numerical variables in a dataset. The novel transformation is a stochastic version of quantile transformation, which we in this thesis name the Randomized Quantile Transformation. In addition to a regular WGAN implementation, the data synthesizing framework tabGAN also implements a WGAN with a conditional generator inspired by the CTGAN data synthesizer. The conditional architecture and training process aim to provide more representation for rare categories in imbalanced columns.

> We compare six data synthesizing methods from the tabGAN framework against the state-of-the-art data synthesizer methods CTGAN, TVAE, CopulaGAN, GaussianCopula, and TabFairGAN. The comparison includes an evaluation of the recreated marginal and joint distributions of a real dataset, as well as a comparison of machine learning efficacy on four real datasets. The methods from the tabGAN framework consistently outperform the other data synthesizing methods. Additionally, the methods from the tabGAN framework run substantially faster than the other GAN based data synthesizers in the evaluation, around 3-4 times faster than CTGAN and CopulaGAN for the real dataset used in the training time comparison. The comparison also indicates that the novel transformation method, the Randomized Quantile Transformation, is very beneficial for dataset variables with many repeated values. We visually verify that methods from the tabGANcf framework are able to generate counterfactual explanations that change the predictions of a black-box classifier whilst not making unnecessary changes to the discrete variables. Sparsity of proposed changes in the numerical variables is, however, still an issue. We propose a potential solution for this that can be investigated in future research. We also provide a list of other extensions that can be implemented in future GAN based counterfactual synthesizers.

## Sammendrag av masteroppgave

